#!/bin/sh

set -eu

IDIR="$PWD"

dirname="$(dirname "$0")"
cd "$dirname"/.. || exit 1
ROOT="$PWD" export ROOT

. "$ROOT/etc/rc"

restart() {
	stop
	cd "$IDIR"
	exec "$dirname/profileinit"
}

stop() {
	kill -15 "$sleep_pid"
	. "$ROOT/etc/rc.shutdown"
}

trap 'restart' 2

trap 'stop' 15

# unless we do this, it doesn't react all signals
sleep infinity &
sleep_pid="$!"
wait
