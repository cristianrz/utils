#!/bin/sh

set -eu

match() {
	case "$1" in
	'*') return 0 ;;
	esac

	[ "$1" -eq "$2" ]
}

HERE="$(
	cd "$(dirname "$0")"
	pwd
)"
CONFIG="$HERE/../../.config"

while true; do
	min="$(date '+%M')"
	hour="$(date '+%H')"
	dom="$(date '+%d')"
	month="$(date '+%m')"
	dow="$(date '+%u')"

	while read -r line; do
		case "$line" in
		'#'*) continue ;;
		esac

		set -f
		set -- $line
		set +f

		match "$1" "$min" || continue
		shift
		match "$1" "$hour" || continue
		shift
		match "$1" "$dom" || continue
		shift
		match "$1" "$month" || continue
		shift
		match "$1" "$dow" || continue
		shift

		"$@" &
	done <"$CONFIG"/crontab

	sleep 60
done
